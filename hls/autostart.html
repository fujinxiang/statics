<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试启动器</title>
    <script src="https://unpkg.com/vue@3.2.33/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.24.0/dist/axios.min.js"></script>
</head>

<body>
    <button onclick="startLoop()">开始测试</button>
    <div id="container">
        <p v-for="item in items">已打开 {{item}}</p>
    </div>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    items: [],
                };
            },
        }).mount("#container");

        const DeviceType = ["导播画面", "电脑画面", "教师全景", "教师特写", "学生全景", "学生特写"]
        const deviceData = [
            {
                host: '192.168.130.14',
                devices: ["37028300111327000101", "37028300111327000102", "37028300111327000104", "37028300111327000106", "37028300111327000108", "37028300111327000110"]
            },
            {
                host: '192.168.130.18',
                devices: ["37028300111327000131", "37028300111327000132", "37028300111327000134", "37028300111327000136", "37028300111327000138", "37028300111327000140"]
            },
            {
                host: '192.168.130.22',
                devices: ["37028300111327000181", "37028300111327000182", "37028300111327000184", "37028300111327000186", "37028300111327000188", "37028300111327000190"]
            },
            {
                host: '192.168.130.24',
                devices: ["37028300111327000201", "37028300111327000202", "37028300111327000204", "37028300111327000206", "37028300111327000208", "37028300111327000210"]
            },
            {
                host: '192.168.130.25',
                devices: ["37028300111327000211", "37028300111327000212", "37028300111327000214", "37028300111327000216", "37028300111327000218", "37028300111327000220"]
            },
            {
                host: '192.168.130.4',
                devices: ["37028300111327000021", "37028300111327000022", "37028300111327000024", "37028300111327000026", "37028300111327000028", "37028300111327000030"]
            },
            {
                host: '192.168.130.6',
                devices: ["37028300111327000041", "37028300111327000042", "37028300111327000044", "37028300111327000046", "37028300111327000048", "37028300111327000050"]
            },
            {
                host: '192.168.130.10',
                devices: ["37028300111327000061", "37028300111327000062", "37028300111327000064", "37028300111327000066", "37028300111327000068", "37028300111327000070"]
            },
            {
                host: '192.168.130.11',
                devices: ["37028300111327000071", "37028300111327000072", "37028300111327000074", "37028300111327000076", "37028300111327000078", "37028300111327000080"]
            },
            {
                host: '192.168.130.36',
                devices: ["37028300111327000321", "37028300111327000322", "37028300111327000324", "37028300111327000326", "37028300111327000328", "37028300111327000330"]
            },
        ]

        const deviceList = []
        for (let i = 0; i < deviceData.length; i++) {
            const obj = deviceData[i];
            for (let j = 0; j < 6; j++) {
                deviceList.push({
                    host: obj.host,
                    type: DeviceType[j],
                    deviceId: obj.devices[j]
                })
            }
        }

        function startLoop() {
            const device = deviceList[0];

            for (let i = 0; i < deviceList.length; i++) {
                const device = deviceList[i];
                setTimeout(() => {
                    openDeviceHls(device);
                }, 1000 * 10 * i);
            }
        }

        function openDeviceHls(device) {
            stopDeviceLive(device.deviceId).then(() => {
                startDeviceLive(device.deviceId).then(result => {
                    console.log(result.data);
                    const streamInfo = result.data.data.streamInfo;
                    const httpsHls = streamInfo.httpsHls;

                    const url = `https://oss.fujinxiang.cn/hls?url=${httpsHls}&host=${device.host}&type=${device.type}`;
                    window.open(url);
                    app.items.push(url);
                })
            })
        }

        function startDeviceLive(deviceId) {
            const options = {
                url: `http://mc-rtc.seewo.com/gbs/api/v1/stream/start`,
                method: "POST",
                type: "json",
                headers: {
                    "Content-Type": "application/json",
                    signature: "a73fbaf1e641fddffb9280ffcca89a60",
                    timestamp: 1655868533,
                    domain: "seewolive.gbs.com",
                },
                data: {
                    traceId: getRandomId(),
                    time: Date.now(),
                    param: {
                        deviceId,
                    },
                },
            };

            return axios(options);
        }

        function stopDeviceLive(deviceId) {
            const options = {
                url: `http://mc-rtc.seewo.com/gbs/api/v1/stream/stop`,
                method: "POST",
                type: "json",
                headers: {
                    "Content-Type": "application/json",
                    signature: "a73fbaf1e641fddffb9280ffcca89a60",
                    timestamp: 1655868533,
                    domain: "seewolive.gbs.com",
                },
                data: {
                    traceId: getRandomId(),
                    time: Date.now(),
                    param: {
                        deviceId,
                    },
                },
            };

            return axios(options);
        }

        function getRandomId() {
            var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            var nums = "";
            for (var i = 0; i < 32; i++) {
                var id = parseInt((Math.random() * 61).toString());
                nums += chars[id];
            }
            return nums;
        }
    </script>
</body>

</html>